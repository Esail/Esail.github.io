<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hadoop,">





  <link rel="alternate" href="/atom.xml" title="Yifan Guo Personal Blog" type="application/atom+xml">






<meta name="description" content="[TOC] 1.Hadoop Yarn is Simple 这个教程将手把手教你如何把一个hello world搬到yarn上运行，然后我们会实现一个简易的parameter server并把它搬到yarn上运行。最后我们会基于spark实现一个和parameter server交互的逻辑回归算法 2.What is Hadoop Yarn http://hadoop.apache.org/ 不知">
<meta name="keywords" content="Hadoop">
<meta property="og:type" content="article">
<meta property="og:title" content="YarnIsSimple">
<meta property="og:url" content="http://www.yifanguo.top/2019/01/16/YarnIsSimple/index.html">
<meta property="og:site_name" content="Yifan Guo Personal Blog">
<meta property="og:description" content="[TOC] 1.Hadoop Yarn is Simple 这个教程将手把手教你如何把一个hello world搬到yarn上运行，然后我们会实现一个简易的parameter server并把它搬到yarn上运行。最后我们会基于spark实现一个和parameter server交互的逻辑回归算法 2.What is Hadoop Yarn http://hadoop.apache.org/ 不知">
<meta property="og:locale" content="default">
<meta property="og:image" content="http://www.yifanguo.top/2019/01/16/YarnIsSimple/YarnIsSimple/ya.png">
<meta property="og:updated_time" content="2019-01-16T08:41:50.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="YarnIsSimple">
<meta name="twitter:description" content="[TOC] 1.Hadoop Yarn is Simple 这个教程将手把手教你如何把一个hello world搬到yarn上运行，然后我们会实现一个简易的parameter server并把它搬到yarn上运行。最后我们会基于spark实现一个和parameter server交互的逻辑回归算法 2.What is Hadoop Yarn http://hadoop.apache.org/ 不知">
<meta name="twitter:image" content="http://www.yifanguo.top/2019/01/16/YarnIsSimple/YarnIsSimple/ya.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://www.yifanguo.top/2019/01/16/YarnIsSimple/">





  <title>YarnIsSimple | Yifan Guo Personal Blog</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <a href="https://github.com/esail" class="github-corner" aria-label="View source on Github"><svg width="80" height="80" viewbox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>


    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Yifan Guo Personal Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-http">
          <a href="/http/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            http
          </a>
        </li>
      
        
        <li class="menu-item menu-item-netty">
          <a href="/netty/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            netty
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            Tags
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.yifanguo.top/2019/01/16/YarnIsSimple/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yifan Guo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/timg.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yifan Guo Personal Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">YarnIsSimple</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-01-16T10:45:57+08:00">
                2019-01-16
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/01/16/YarnIsSimple/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2019/01/16/YarnIsSimple/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              

              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Reading time &asymp;</span>
                
                <span title="Reading time">
                  12
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>[TOC]</p>
<h1><span id="1hadoop-yarn-is-simple">1.Hadoop Yarn is Simple</span></h1>
<p>这个教程将手把手教你如何把一个hello world搬到yarn上运行，然后我们会实现一个简易的parameter server并把它搬到yarn上运行。最后我们会基于spark实现一个和parameter server交互的逻辑回归算法</p>
<h1><span id="2what-is-hadoop-yarn">2.What is Hadoop Yarn</span></h1>
<p>http://hadoop.apache.org/ 不知道hadoop是什么的自己看吧</p>
<p>简单来说我们通常说的hadoop由三部分组成，即负责分布式存储的hdfs, 负责分布式计算的mapReduce,负责分布式资源调度的Yarn.</p>
<p>相比于单机系统，hdfs就相当于单机的disk，mapReduce是运行在系统中的app, 资源调度就是操作系统</p>
<h1><span id="3yarn-architecture">3.Yarn Architecture</span></h1>
<p><img src="./YarnIsSimple/ya.png" alt="ya"></p>
<p>我们先来看yarn的结构，yarn两个主要的任务是1. 资源管理 (resource management) 2. 调度监测任务</p>
<p>(Job scheduling&amp;monitoring)</p>
<p>所以根据这个理念 我们主要有三个大的组件，即</p>
<ul>
<li>ResourceManager(RM) 负责管理集群所有的可用资源</li>
<li>NodeManager(NM) 负责一台机器上的资源管理，主要是启动荣旗，监测（cpu,memory, disk, network)并把情况汇报给RM</li>
<li>ApplicationMaster(AM)负责一个application的运行，AM会向RM请求资源，然后和NM一起把具体运行任务的容器拉起来</li>
</ul>
<p>所以yarn的framework的设计是非常清晰的，即</p>
<ul>
<li>针对整个集群的框架 RM per cluster</li>
<li>针对单台机器的框架 NM per machine</li>
<li>针对单个运行程序的框架 AM per application</li>
</ul>
<p>了解清楚了Yarn的设计目的，我们再看这个架构图就更清晰了整个流程如下：</p>
<ol>
<li>客户端机向RM提交任务(submit job)</li>
<li>RM接到任务后，会查看集群资源是否足够运行该任务</li>
<li>如果资源充足，就命令NM启动运行AM的container</li>
<li>AM向RM请求运行具体执行任务的资源</li>
<li>RM命令NM启动容器执行具体任务</li>
<li>AM负责监控所有容器的运行情况</li>
<li>NM向RM报告节点的运行状况</li>
</ol>
<p>这个操作看上去是不是很熟悉，我们想象下单机你启动游戏，操作系统(NM)要为游戏(AM)分配对应的内存和cpu资源，然后启动游戏(AM)。如果游戏内有多个操作在进行，由你(AM)负责管理这些操作（Container)</p>
<p>而分布式的区别就在于我们用RM+NM来管理所有的节点上的所有操作</p>
<h2><span id="resourcemanager">ResourceManager</span></h2>
<p>RM是集群最高领导人，统管集群所有的资源和监控运行情况。它主要有两部分组成即调取器scheduler和应用程序管理器application manager(注意不是AM，这个很容易搞混)</p>
<p>Scheduler的目的是合理分配集群资源</p>
<p>applicationManager的目的是为了监控所有app的运行状况</p>
<h3><span id="scheduler">Scheduler</span></h3>
<p>scheduler是纯粹的，高尚的，只负责调度资源，至于app挂了，节点挂了，统统不管。它只关心各个节点上的cpu,memory, network, disk, gpu的使用情况</p>
<p>scheduler的两个调度机制如下： capacityScheduler 和 FairScheduler</p>
<p>https://hadoop.apache.org/docs/current/hadoop-yarn/hadoop-yarn-site/CapacityScheduler.html</p>
<p>https://hadoop.apache.org/docs/current/hadoop-yarn/hadoop-yarn-site/FairScheduler.html</p>
<p>具体的机制不再细讲了，可以去参考上述两个链接，简单来说</p>
<p>capacityScheduler保证集群的资源要高可用（富人优先，穷人靠边的思路）</p>
<p>fairScheduler保证集群的资源要公平分配，大家不要打架（不患寡而患不均的思想）</p>
<h3><span id="application-manager">Application Manager</span></h3>
<p>ApplicationManager当然就负责其他的事情了，监测所有application的运行情况，命令NM启动AM，如果AM挂了就重新启动。然后由AM向scheduler请求资源，最后启动容器来运行任务</p>
<h1><span id="4-yarn-常见的命令">4. yarn 常见的命令</span></h1>
<p>https://hadoop.apache.org/docs/current/hadoop-yarn/hadoop-yarn-site/YarnCommands.html</p>
<p>参考上述链接，我们常用的有</p>
<p>yarn application -kill &lt;application_id&gt; kill掉一个yarn application</p>
<p>yarn logs -applicationId  &lt;application_id&gt; 查看application运行的日志</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">Usage: yarn [--config confdir] [COMMAND | CLASSNAME]</span><br><span class="line">  CLASSNAME                             run the class named CLASSNAME</span><br><span class="line"> or</span><br><span class="line">  where COMMAND is one of:</span><br><span class="line">  resourcemanager -format-state-store   deletes the RMStateStore</span><br><span class="line">  resourcemanager                       run the ResourceManager</span><br><span class="line">  nodemanager                           run a nodemanager on each slave</span><br><span class="line">  timelineserver                        run the timeline server</span><br><span class="line">  rmadmin                               admin tools</span><br><span class="line">  sharedcachemanager                    run the SharedCacheManager daemon</span><br><span class="line">  scmadmin                              SharedCacheManager admin tools</span><br><span class="line">  version                               print the version</span><br><span class="line">  jar &lt;jar&gt;                             run a jar file</span><br><span class="line">  application                           prints application(s)</span><br><span class="line">                                        report/kill application</span><br><span class="line">  applicationattempt                    prints applicationattempt(s)</span><br><span class="line">                                        report</span><br><span class="line">  container                             prints container(s) report</span><br><span class="line">  node                                  prints node report(s)</span><br><span class="line">  queue                                 prints queue information</span><br><span class="line">  logs                                  dump container logs</span><br><span class="line">  classpath                             prints the class path needed to</span><br><span class="line">                                        get the Hadoop jar and the</span><br><span class="line">                                        required libraries</span><br><span class="line">  cluster                               prints cluster information</span><br><span class="line">  daemonlog                             get/set the log level for each</span><br><span class="line">                                        daemon</span><br></pre></td></tr></table></figure></p>
<h1><span id="5-writing-a-hello-world-on-yarn">5. Writing a Hello world on yarn</span></h1>
<p>说了那么多，终于到正题了，现在我们来手把手写一个hello world on yarn。</p>
<p>我们将使用scala来完成这个程序，如果你不熟悉scala请看：https://www.tutorialspoint.com/scala/</p>
<p>再来回顾下一个app从提交到运行的整个流程：</p>
<ol>
<li>客户端机向RM提交任务(submit job)</li>
<li>RM接到任务后，会查看集群资源是否足够运行该任务(verify resources)</li>
<li>如果资源充足，就命令NM启动运行AM的container(start AM)</li>
<li>AM向RM请求运行具体执行任务的资源(AM -&gt; RM)</li>
<li>RM命令NM启动容器执行具体任务(RM-&gt; NM)</li>
<li>AM负责监控所有执行该任务的容器的运行情况(AM reports)</li>
<li>NM向RM报告节点的运行状况(NM reports)</li>
</ol>
<p>这个流程一定要非常清楚，否则整个on yarn的程序对你来说会非常痛苦</p>
<p>针对这个流程，我们看到，我们需要完成三个主要的通信</p>
<p>1） submit job aka Client --- RM</p>
<p>客户端机向RM提交任务 通过YarnClient这个类来完成</p>
<ol start="2">
<li>AM向RM请求资源</li>
</ol>
<p>AMRMClientAsync使用这个类， events通过AMRMClientAsync.CallbackHandler来处理</p>
<p>3）AM和NM协作启动容器</p>
<p>NMClientAsync。 handling container events by <code>NMClientAsync.CallbackHandler</code></p>
<p>三个通信协议</p>
<p>ApplicationClientProtocol, ApplicationMasterProtocol 和 ContainerManagementProtocol 被上述三个client包裹。大多数情况，所有的通信都通过上述三个client来进行，如果需要特别的定制化操作，可以使用这三个protocol来自己操作</p>
<p>好了话不多说，开始写&quot;Hello world&quot;</p>
<h2><span id="hello-world-on-yarn">Hello world on Yarn</span></h2>
<h3><span id="step1-submit-job">Step1 submit job</span></h3>
<p>首先回忆第一步，我需要操作YarnClient这个类去提交一个application给RM。代码结构如下</p>
<p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> yarnClient = <span class="type">YarnClient</span>.createYarnClient		</span><br><span class="line"><span class="comment">// 初始化</span></span><br><span class="line">yarnClient.init(conf)</span><br><span class="line"><span class="comment">// 启动yarnClient</span></span><br><span class="line">yarnClient.start()</span><br></pre></td></tr></table></figure></p>
<p>当yarnClient启动后，我们需要创建一个新的application, 然后拿到它的response</p>
<p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> newApp = yarnClient.createApplication()</span><br><span class="line"><span class="keyword">val</span> newAppResponse = newApp.getNewApplicationResponse</span><br><span class="line">appId = newAppResponse.getApplicationId</span><br></pre></td></tr></table></figure></p>
<p>完整代码</p>
<p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Client</span>(<span class="params">conf: <span class="type">Configuration</span></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">val</span> log = <span class="type">LoggerFactory</span>.getLogger(<span class="keyword">this</span>.getClass)</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 创建一个yarnClient</span></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">val</span> yarnClient = <span class="type">YarnClient</span>.createYarnClient</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">def</span> <span class="title">submitApplication</span></span>() : <span class="type">ApplicationId</span> = &#123;</span><br><span class="line">  <span class="keyword">var</span> appId: <span class="type">ApplicationId</span> = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化</span></span><br><span class="line">  yarnClient.init(conf)</span><br><span class="line">  <span class="comment">// 启动yarnClient</span></span><br><span class="line">  yarnClient.start()</span><br><span class="line"></span><br><span class="line">  log.info(<span class="string">"Requesting a new application from cluster with %d NodeManagers"</span></span><br><span class="line">   .format(yarnClient.getYarnClusterMetrics.getNumNodeManagers))</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建一个新的app然后拿到appResponse和Id</span></span><br><span class="line">  <span class="keyword">val</span> newApp = yarnClient.createApplication()</span><br><span class="line">  <span class="keyword">val</span> newAppResponse = newApp.getNewApplicationResponse</span><br><span class="line">  appId = newAppResponse.getApplicationId</span><br><span class="line">  </span><br><span class="line">  appId</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>是不是非常简单</p>
<p>newAppResponse中包含了cluster中资源capacity信息，这是为下一步启动AM做准备(step2), 你马上就能看到</p>
<h3><span id="step2-verify-resource-capacity">step2 verify resource capacity</span></h3>
<p>为了验证集群资源能力，防止我们请求了不合理的资源，我们需要对cluster resource capacity做一次验证</p>
<p>为了验证我们需要引入四个新的常量，为了后面和spark交互，我们统一和spark命名一致</p>
<p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> amMemory = <span class="number">512</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> amCores = <span class="number">1</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> executorMemory = <span class="number">1024</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> executorCores = <span class="number">1</span></span><br></pre></td></tr></table></figure></p>
<p>默认值也和spark一致，我们给AM分配512m内存, 1个core. 给executor分配1024m内存，1个core</p>
<p>验证代码</p>
<p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">verifyClusterResources</span></span>(newAppResponse: <span class="type">GetNewApplicationResponse</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line"> <span class="keyword">val</span> maxMem = newAppResponse.getMaximumResourceCapability.getMemory</span><br><span class="line"> <span class="keyword">if</span> (executorMemory &gt; maxMem) &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">IllegalArgumentException</span>(<span class="string">s"Required executor memory (<span class="subst">$executorMemory</span>),"</span> +</span><br><span class="line">   <span class="string">s"the max threshold (<span class="subst">$maxMem</span> MB) of this cluster! Please check the values of "</span> +</span><br><span class="line">   <span class="string">s"'yarn.scheduler.maximum-allocation-mb' and/or 'yarn.nodemanager.resource.memory-mb'."</span>)</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">if</span> (amMemory &gt; maxMem) &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">IllegalArgumentException</span>(<span class="string">s"Required AM memory <span class="subst">$amMemory</span> "</span> +</span><br><span class="line">   <span class="string">s"is above the max threshold (<span class="subst">$maxMem</span> MB) of this cluster! "</span> +</span><br><span class="line">   <span class="string">"Please check the values of 'yarn.scheduler.maximum-allocation-mb' and/or "</span> +</span><br><span class="line">   <span class="string">"'yarn.nodemanager.resource.memory-mb'."</span>)</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3><span id="step3-启动am">Step3 启动AM</span></h3>
<p>如果你坚持看到了这里，那么你马上迎来最复杂的步骤，越过这座山，后面就是星辰大海。</p>
<p>我们知道ApplicationMaster是负责管理运行这个app的所有的容器的，所以我们首先要向RM请求一个容器用来启动AM.</p>
<p>我们要操作的类是 ApplicationSubmissionContext(后面简称ASC), 这个类定义了所有RM需要启动AM的信息。</p>
<p>作为客户端机我们主要需要set以下几个field</p>
<p>1 application info: 主要包括id 和name</p>
<ol start="2">
<li>
<p>queue 提交的队列， priority 任务执行的优先级</p>
</li>
<li>
<p>user: 谁在向RM submmit app</p>
</li>
<li>
<p>ContainerLaunchContext：启动容器所需的上下文。我们后面简称是CLC</p>
</li>
</ol>
<p>CLC 主要包含：</p>
<p>a) local resources(binaries, jars, files) 本地的资源</p>
<p>b) Environment Settings(CLASSPATH etc) 容器所需的环境变量</p>
<p>c) the command to be executed 需要执行的命令</p>
<p>d) security tokens 处理安全tokens</p>
<p>好我们看如何操作这个类</p>
<p>首先解决clc</p>
<p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建一个clc</span></span><br><span class="line"><span class="keyword">val</span> clc = <span class="type">Records</span>.newRecord(classOf[<span class="type">ContainerLaunchContext</span>])</span><br><span class="line"><span class="comment">// 然后set我们需要的fields</span></span><br><span class="line">clc.setCommands(<span class="literal">null</span>) <span class="comment">// am里要执行的命令</span></span><br><span class="line">clc.setLocalResources(<span class="literal">null</span>) <span class="comment">// 需要的本地资源</span></span><br><span class="line">clc.setEnvironment(<span class="literal">null</span>) <span class="comment">// am里运行所需的环境变量</span></span><br><span class="line">clc.setTokens(<span class="literal">null</span>) <span class="comment">// 安全验证tokens</span></span><br></pre></td></tr></table></figure></p>
<p>具体的implementations请看完整代码</p>
<p>然后ASC</p>
<p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> clc = createContainerLaunchContext(newAppResponse) <span class="comment">// 创建一个clc</span></span><br><span class="line"><span class="keyword">val</span> asc = newApp.getApplicationSubmissionContext <span class="comment">// 创建一个asc</span></span><br><span class="line">asc.setResource(ascSetResource()) <span class="comment">// 设置am所需的资源</span></span><br><span class="line">asc.setAMContainerSpec(clc) <span class="comment">// 设置clc</span></span><br></pre></td></tr></table></figure></p>
<p>最后提交任务</p>
<p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarnClient.submitApplication(asc)</span><br></pre></td></tr></table></figure></p>
<p>没了，不要怀疑，on yarn看上去非常复杂，但其实就是set, set ,set就搞定了。关键是你要了解整个架构运行的原理和机制这样才能set好。所有的xxx on yarn本质上都是如此(tensorflow on yarn, pytorch on yarn, mxnet on yarn, spark on yarn ,flink on yarn) 之后有空的话，我们再手把手把tensorflow dnn训练mnist搬到yarn上来做分布式</p>
<p>具体set的内容可以参考完整代码</p>
<h3><span id="writing-an-applicationmaster">Writing an ApplicationMaster</span></h3>
<p>下面该轮到AM了，AM我们再回顾下它的职责，</p>
<p>AM per application 每个应用一个</p>
<p>AM由RM来启动，通过client来提交</p>
<p>AM管理任务直到任务完成</p>
<p>我们看下官方解释</p>
<ul>
<li>The AM is the actual owner of the job. It will be launched by the RM and via the client will be provided all the necessary information and resources about the job that it has been tasked with to oversee and complete.</li>
<li>As the AM is launched within a container that may (likely will) be sharing a physical host with other containers, given the multi-tenancy nature, amongst other issues, it cannot make any assumptions of things like pre-configured ports that it can listen on.</li>
<li>When the AM starts up, several parameters are made available to it via the environment. These include the <code>ContainerId</code> for the AM container, the application submission time and details about the NM (NodeManager) host running the ApplicationMaster. Ref <code>ApplicationConstants</code> for parameter names.</li>
<li>All interactions with the RM require an <code>ApplicationAttemptId</code> (there can be multiple attempts per application in case of failures). The <code>ApplicationAttemptId</code> can be obtained from the AM’s container id. There are helper APIs to convert the value obtained from the environment into objects.</li>
</ul>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Hadoop/" rel="tag"># Hadoop</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/01/07/SparkML源码分析/" rel="next" title="SparkML源码分析">
                <i class="fa fa-chevron-left"></i> SparkML源码分析
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/01/16/xdl源码解读/" rel="prev" title="xdl源码解读">
                xdl源码解读 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/timg.jpeg" alt="Yifan Guo">
            
              <p class="site-author-name" itemprop="name">Yifan Guo</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">65</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">37</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">1.</span> <span class="nav-text">1.Hadoop Yarn is Simple</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">2.</span> <span class="nav-text">2.What is Hadoop Yarn</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">3.</span> <span class="nav-text">3.Yarn Architecture</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#undefined"><span class="nav-number">3.1.</span> <span class="nav-text">ResourceManager</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#undefined"><span class="nav-number">3.1.1.</span> <span class="nav-text">Scheduler</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#undefined"><span class="nav-number">3.1.2.</span> <span class="nav-text">Application Manager</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">4.</span> <span class="nav-text">4. yarn 常见的命令</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">5.</span> <span class="nav-text">5. Writing a Hello world on yarn</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#undefined"><span class="nav-number">5.1.</span> <span class="nav-text">Hello world on Yarn</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#undefined"><span class="nav-number">5.1.1.</span> <span class="nav-text">Step1 submit job</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#undefined"><span class="nav-number">5.1.2.</span> <span class="nav-text">step2 verify resource capacity</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#undefined"><span class="nav-number">5.1.3.</span> <span class="nav-text">Step3 启动AM</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#undefined"><span class="nav-number">5.1.4.</span> <span class="nav-text">Writing an ApplicationMaster</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Yifan Guo</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">72.7k</span>
  

  
  <script src="https://unpkg.com/mermaid@7.1.2/dist/mermaid.min.js"></script>
  <script>
    if (window.mermaid) {
      mermaid.initialize("");
    }
  </script>
  

</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: 'KEMmgyPyFfhr16k5eObb6hNb-gzGzoHsz',
        appKey: '3NaHttXmiYWcqAs4ihatgQqo',
        placeholder: 'Just go go',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  





  

  

  

  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

  
</body>
</html>
